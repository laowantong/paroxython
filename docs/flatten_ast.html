<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.1" />
<title>paroxython.flatten_ast API documentation</title>
<meta name="description" content="Return a non-recursive, multiline dump of the AST (with some tweaks) …" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS_CHTML" integrity="sha256-kZafAc6mZvK3W3v1pHOcUix30OHQN6pU/NO2oFkqZVw=" crossorigin></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
<a href="https://github.com/laowantong/paroxython"><img style="position: absolute; top: 0; right: 0; border: 0; width: 150px; height: 150px" src="https://laowantong.github.io/paroxython/resources/source_on_github.png" alt="Source on GitHub"></a>
<style>.homelink{display:block}.homelink:hover{color:inherit}.homelink img{margin:auto;margin-bottom:.3em}</style>
<link rel="canonical" href="https://laowantong.github.io/paroxython/flatten_ast.html">
<link rel="icon" href="https://laowantong.github.io/paroxython/resources/logo.png">
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>paroxython.flatten_ast</code></h1>
</header>
<section id="section-intro">
<p>Return a non-recursive, multiline dump of the <abbr title="Abstract Syntax Tree">AST</abbr> (with some tweaks).</p>
<h2 id="motivation-and-purpose">Motivation and purpose</h2>
<p><a href="https://en.wikipedia.org/wiki/Static_program_analysis">Static analysis</a> tools like Paroxython
generally start with the <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree"><abbr title="Abstract Syntax Tree">AST</abbr></a> (abstract syntax
tree) of the program to analyze. For instance, when the string:</p>
<pre><code class="python">'print(&quot;hello, world&quot;)'
</code></pre>
<p>&hellip; is fed to the function <code>parse()</code> of the modules <a href="https://docs.python.org/3/library/ast.html"><code>ast</code></a>
or <a href="https://github.com/python/typed_ast"><code>typed_ast</code></a>, the following object is returned:</p>
<pre><code class="plain">                           Module()
                              |
                              | body[0]
                              |
                            Expr()
                              |
                              | value
                              |
                            Call()
                             / \
                       func /   \ args[0]
                           /     \
Name(id='print', ctx=Load())     Str(s='hello, world', kind='')
</code></pre>
<p>The purpose of our function <code><a title="paroxython.flatten_ast.flatten_ast" href="#paroxython.flatten_ast.flatten_ast">flatten_ast()</a></code> is to transform this nested structure into a curated
pre-ordered sequence of text lines, each of which consisting in a key-value pair. A key is the
complete path from the root of the <abbr title="Abstract Syntax Tree">AST</abbr> to either a node (e.g., <code>Name()</code>) or a node attribute
(e.g., <code>id</code>). The associated value comes after an equals sign (<code>=</code>):</p>
<pre><code class="plain">/_type=Module
/body/_length=1
/body/1/_type=Expr
/body/1/_pos=1:1-
/body/1/value/_type=Call
/body/1/value/_hash=0x0001
/body/1/value/_pos=1:1-0-
/body/1/value/func/_type=Name
/body/1/value/func/_hash=0x0002
/body/1/value/func/_pos=1:1-0-0-
/body/1/value/func/id=print
/body/1/value/func/ctx/_type=Load
/body/1/value/args/_length=1
/body/1/value/args/1/_type=Str
/body/1/value/args/1/_hash=0x0003
/body/1/value/args/1/_pos=1:1-0-1-1-
/body/1/value/args/1/s=hello, world
/body/1/value/keywords/_length=0
/type_ignores/_length=0
</code></pre>
<p>Obviously, such a representation is quite verbose. But every single line encapsulates most of the
nesting information we need to understand its context. Since the recursion is linearly encoded,
requesting it does not require recursion any more. Thus,
<a href="https://en.wikipedia.org/wiki/Regular_expression">regular expressions</a> become natural candidates
for the request language<sup id="fnref:regex-recursion"><a class="footnote-ref" href="#fn:regex-recursion">1</a></sup>. The current version of Paroxython explores this option.
The regular expression patterns are processed in <code><a title="paroxython.parse_program" href="parse_program.html">paroxython.parse_program</a></code> on the basis of the
definitions listed in <a href="https://github.com/laowantong/paroxython/blob/master/paroxython/resources/spec.md"><code>spec.md</code></a>.</p>
<p>For instance, the following regular expression matches and localizes the nested function calls
(e.g., <code>foo(bar(42))</code>) without any recursion:</p>
<pre><code class="re">           ^(.*)                    # Capture the path originating from the root...
                /_type=Call         #  ... to the nesting call.
\n(?:\1.+\n)*?\1                    # Skip any number of attributes of this call...
                /_pos=(?P&lt;POS&gt;.+)   # ... until we find and capture its line number.
\n(?:\1.+\n)* \1                    # Skip any number of...
                /args/.*            # ... arguments of this call...
                        /_type=Call # ... until we find a nested call.
</code></pre>
<p>When the first call is found, continuing in the subtree is a simple matter of restricting the search
to the block of lines that share the same prefix (referred by <code>\1</code>).</p>
<p>That's the general principle. In the next section, we enumerate the tweaks we make to the generation
of this text to make it more suitable for regular expression parsing.</p>
<h2 id="implementation-details">Implementation details</h2>
<h3 id="libraries-used">Libraries used</h3>
<p>When Paroxython is launched from Python 3.7 or lower, the parsing of source code into an <abbr title="Abstract Syntax Tree">AST</abbr> is
performed by the third-party library <a href="https://github.com/python/typed_ast">typed-ast</a>. To quote the
README:</p>
<blockquote>
<p><code>typed_ast</code> is a Python 3 package that provides a [&hellip;] parser similar to the standard <code>ast</code> library.
Unlike <code>ast</code>, the parsers [&hellip;] are independent of the version of Python under which they are run.
[&hellip;] <code>typed_ast</code> runs on CPython 3.5-3.8</p>
</blockquote>
<p>So far so good. However:</p>
<blockquote>
<p><code>typed_ast</code> will not be updated to support parsing Python 3.8 and newer.</p>
</blockquote>
<p>This means that <code>typed_ast</code>, although convenient to parse Python 3.5 and newer, will chope on
Python 3.8 specific syntax, as assignment expressions.</p>
<p>This is the reason why, when launched from Python 3.8 or higher, Paroxython switches to the parser of
the standard library <a href="https://docs.python.org/3/library/ast.html"><code>ast</code></a>. However, the ASTs generated
by the two libraries are not 100% identical. Wrapping their parsers requires us to erase as much
differences as possible. Some of the functions presented below are written for this purpose.</p>
<h3 id="on-the-fly-modification-of-the-ast">On the fly: modification of the <abbr title="Abstract Syntax Tree">AST</abbr></h3>
<h4 id="field-reordering">Field reordering</h4>
<p>Somewhat counterintuitively, in the original <abbr title="Abstract Syntax Tree">AST</abbr>, several pieces of information pertaining to a
function signature or decoration are rejected <em>after</em> the body of the function. As a result, we
lose the interesting property that the line numbers cannot decrease. We fix this by making <code>body</code>
the last field of a function or class definition
(see <a href="https://github.com/laowantong/paroxython/issues/4">issue #4</a>).</p>
<h4 id="children-numbering">Children numbering</h4>
<p>A counter is inserted between each node and its children. Starting from 1 enables us to find the
last one by matching its number with the (previously captured) length of the list.</p>
<h4 id="field-disambiguation">Field disambiguation</h4>
<p>Accross the <abbr title="Abstract Syntax Tree">AST</abbr>, the same fields are sometimes used in different contexts. To make it easier or
even possible to detect certain features, their usage is disambiguated by applying the following
renaming rules:</p>
<ul>
<li><code>orelse</code>: used for both loop and conditional <code>else</code> branches. Replace the former with <code>loopelse</code>.</li>
<li><code>target</code>: used for assignment, comprehension, etc. Replace the former with <code>assigntarget</code>.</li>
<li><code>targets</code>: used for augmented assignment, deletion, etc. Replace the former with <code>assigntargets</code>.</li>
<li><code>value</code>: used for assignment (augmented or not), comprehension, assignment-expressions, etc.
Replace the former ones with <code>assignvalue</code>.</li>
</ul>
<p>Thus, in the output, there is no more need to search for the context of a field in the previous or
following lines.</p>
<h4 id="added-fields">Added fields</h4>
<ul>
<li><code>_type</code>: stores the name of the node (e.g., <code>Module</code>, <code>Expr</code>, <code>Call</code>).</li>
<li><code>_pos</code>: stores the line number (extracted from the attribute <code>lineno</code> of the node, if
any<sup id="fnref:lineno"><a class="footnote-ref" href="#fn:lineno">2</a></sup>), followed by a colon <code>:</code>, followed by the path from the root of the <abbr title="Abstract Syntax Tree">AST</abbr> to this
node. A path is coded as a sequence of positive integers, hyphen-separated and ended by a hyphen.
Its fundamental property is: node <span><span class="MathJax_Preview">n_2</span><script type="math/tex">n_2</script></span> is nested within node <span><span class="MathJax_Preview">n_1</span><script type="math/tex">n_1</script></span> iff the path of <span><span class="MathJax_Preview">n_1</span><script type="math/tex">n_1</script></span>
is a prefix of the path of <span><span class="MathJax_Preview">n_2</span><script type="math/tex">n_2</script></span>.</li>
<li><code>_hash</code>: see next section.</li>
</ul>
<h4 id="expression-decontextualization-and-hashing">Expression decontextualization and hashing</h4>
<p>In order to detect certain features, such as
<a href="https://github.com/laowantong/paroxython/blob/master/paroxython/resources/spec.md#feature-swap"><code>swap</code></a>:</p>
<pre><code class="python">(a[i], a[j]) = (a[j], a[i])
</code></pre>
<p>&hellip; we need to recognize a given expression accross its various occurrences. For this, we tweak the
output of the library function <code>ast.dump()</code>. For instance, in the following statement:</p>
<pre><code class="python">a[i] = 42
</code></pre>
<p>&hellip; the expression <code>a[i]</code> is dumped as the string:</p>
<pre><code class="python">&quot;Subscript(value=Name(id='a', ctx=Load()), slice=Index(value=Name(id='i', ctx=Load())), ctx=Store())&quot;
</code></pre>
<p>However, in:</p>
<pre><code class="python">    return a[i]
</code></pre>
<p>&hellip; the same expression <code>a[i]</code> is dumped as the string:</p>
<pre><code class="python">&quot;Subscript(value=Name(id='a', ctx=Load()), slice=Index(value=Name(id='i', ctx=Load())), ctx=Load())&quot;
</code></pre>
<p>As you can see, these two strings are not equal, due to the fact that the dump specifies not only
<em>which</em> expressions are used, but <em>how</em> they are used: this is the purpose of the field <code>ctx</code>. Once
this context is removed, both strings become:</p>
<pre><code class="python">&quot;Subscript(value=Name(id='a'), slice=Index(value=Name(id='i')))&quot;
</code></pre>
<p>They can now be represented by the same hash value<sup id="fnref:pseudo-hash"><a class="footnote-ref" href="#fn:pseudo-hash">3</a></sup>, stored in the added field <code>_hash</code>.</p>
<h3 id="after-the-fact-modification-of-the-flattened-ast">After the fact: modification of the flattened <abbr title="Abstract Syntax Tree">AST</abbr></h3>
<h4 id="negative-literal-simplification">Negative literal simplification</h4>
<p>Normally, the <abbr title="Abstract Syntax Tree">AST</abbr> structure of a numeric literal depends on its sign. For instance, 42 is parsed
as:</p>
<pre><code class="python">Expr(value=Num(n=42))
</code></pre>
<p>&hellip; while -42 is parsed as:</p>
<pre><code class="python">Expr(value=UnaryOp(op=USub(), operand=Num(n=42)))
</code></pre>
<p>To unify the further treatment of numbers, the function <code><a title="paroxython.flatten_ast.simplify_negative_literals" href="#paroxython.flatten_ast.simplify_negative_literals">simplify_negative_literals()</a></code> post-processes
the generated flat representation to transform this kind of output:</p>
<pre><code class="plain">/body/1/_type=Expr
/body/1/_pos=1:1-
/body/1/value/_type=UnaryOp
/body/1/value/_hash=0x0001
/body/1/value/_pos=1:1-0-
/body/1/value/op/_type=USub
/body/1/value/operand/_type=Num
/body/1/value/operand/_hash=0x0002
/body/1/value/operand/_pos=1:1-0-1-
/body/1/value/operand/n=42
</code></pre>
<p>into this one:</p>
<pre><code class="plain">/body/1/_type=Expr
/body/1/_pos=1:1-
/body/1/value/_type=Num
/body/1/value/_hash=0x0001
/body/1/value/_pos=1:1-0-
/body/1/value/n=-42
</code></pre>
<h4 id="index-simplification">Index simplification</h4>
<p>Since Python 3.9, the class <code>ast.Index</code> is deprecated: simple indexes are represented by their value.</p>
<p>For instance, <code>a[42]</code> is parsed as:</p>
<pre><code class="python">[...] slice=Constant(value=42) [...]
</code></pre>
<p>&hellip; instead of:</p>
<pre><code class="python">[...] slice=Index(value=Constant(value=42))) [...]
</code></pre>
<p>To unify the further treatment of indexes, the function <code><a title="paroxython.flatten_ast.simplify_indexes" href="#paroxython.flatten_ast.simplify_indexes">simplify_indexes()</a></code> post-processes the
generated flat representation to transform this kind of output:</p>
<pre><code class="plain">/body/1/_type=Expr
/body/1/_pos=1:1-
/body/1/value/_type=Subscript
/body/1/value/_hash=0x0001
/body/1/value/_pos=1:1-0-
/body/1/value/value/_type=Name
/body/1/value/value/_hash=0x0002
/body/1/value/value/_pos=1:1-0-0-
/body/1/value/value/id=a
/body/1/value/value/ctx/_type=Load
/body/1/value/slice/_type=Index           # Line to be suppressed.
/body/1/value/slice/value/_type=Num       # Lines to be simplified...
/body/1/value/slice/value/_hash=0x0003    # ...
/body/1/value/slice/value/_pos=1:1-0-1-0- # ...
/body/1/value/slice/value/n=42            # ...
/body/1/value/ctx/_type=Load
</code></pre>
<p>into this one:</p>
<pre><code class="plain">/body/1/_type=Expr
/body/1/_pos=1:1-
/body/1/value/_type=Subscript
/body/1/value/_hash=0x0001
/body/1/value/_pos=1:1-0-
/body/1/value/value/_type=Name
/body/1/value/value/_hash=0x0002
/body/1/value/value/_pos=1:1-0-0-
/body/1/value/value/id=a
/body/1/value/value/ctx/_type=Load
/body/1/value/slice/_type=Num        # Simplified lines...
/body/1/value/slice/_hash=0x0003     # ...
/body/1/value/slice/_pos=1:1-0-1-    # ... (the last segment of the path is dropped)
/body/1/value/slice/n=42             # ...
/body/1/value/ctx/_type=Load
</code></pre>
<h4 id="suppressing-useless-lines">Suppressing useless lines</h4>
<ul>
<li>Starting with Python 3.8, <code>kind</code> is an attribute of a constant allowing tools to distinguish
certain flavors of the strings . Its possible values are <code>"rf"</code>, <code>"f"</code>, <code>"u"</code> and <code>""</code> in the
third-party library <code>typed_ast</code>, but <code>"u"</code> and <code>None</code> in the Python 3.8 standard library <code>ast</code>.
Since such details are of no interest to us, we don't bother making them consistent. The function
<code><a title="paroxython.flatten_ast.suppress_kinds" href="#paroxython.flatten_ast.suppress_kinds">suppress_kinds()</a></code> deletes from the flat <abbr title="Abstract Syntax Tree">AST</abbr> any line ending with <code>kind=.*</code>.</li>
<li>Python 3.8 introduces <a href="https://www.python.org/dev/peps/pep-0570/">positional-only parameters</a>
to respond to “certain challenges for library authors and users of APIs”. This is far beyond our
pedagogical scope: we are afraid we have no choice but to sell these lines for scientific
experiments (<code><a title="paroxython.flatten_ast.suppress_posonlyargs" href="#paroxython.flatten_ast.suppress_posonlyargs">suppress_posonlyargs()</a></code>).</li>
</ul>
<h4 id="reverting-the-representation-of-constants-to-the-good-ol-days">Reverting the representation of constants to the good ol' days</h4>
<p>Probably for excellent reasons, Python 3.8 has decided that <code>Num(n)</code>, <code>Str(s)</code>, <code>Bytes(s)</code>,
<code>Ellipsis</code> and <code>NameConstant(value)</code> should all be unified under <code>Constant(value)</code>. As far as we
are concerned, this change makes the type of the constants much harder to determine. Until we
know more, we are restoring the previous representations with <code><a title="paroxython.flatten_ast.backport_all_constants" href="#paroxython.flatten_ast.backport_all_constants">backport_all_constants()</a></code>.</p>
<h4 id="unquoting-strings">Unquoting strings</h4>
<p><code><a title="paroxython.flatten_ast.unquote" href="#paroxython.flatten_ast.unquote">unquote()</a></code> suppress the single or double quotes delimiters after <code>=</code>. This makes for simpler regular
expressions in <a href="https://github.com/laowantong/paroxython/blob/master/paroxython/resources/spec.md"><code>spec.md</code></a>.</p>
<h4 id="correcting-the-span-of-decorated-callable">Correcting the span of decorated callable</h4>
<p><code><a title="paroxython.flatten_ast.correct_all_decorated_callable_starts" href="#paroxython.flatten_ast.correct_all_decorated_callable_starts">correct_all_decorated_callable_starts()</a></code> fixes a bug of <code>typed_ast</code> in which decorated functions
and classes would incorrectly be marked as starting from the line of their first decorator.</p>
<div class="footnote">
<hr>
<ol>
<li id="fn:regex-recursion">
<p>Although nowadays, numerous flavours of regex engines support recursion,
the complexity of writing, reading and maintaining any pattern using it would quickly go through the
roof.&#160;<a class="footnote-backref" href="#fnref:regex-recursion" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:lineno">
<p>Numerous nodes, e.g. <code>Module</code>, <code>Store</code>, <code>Load</code>, <code>Lt</code>, <code>Add</code>, are not associated with a
line number.&#160;<a class="footnote-backref" href="#fnref:lineno" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:pseudo-hash">
<p>Actually, to avoid dealing with hash randomization in the unit tests, we use a function which
merely increments a counter and associates it with any newly encountered string
(see <code><a title="paroxython.flatten_ast.PseudoHashFactory" href="#paroxython.flatten_ast.PseudoHashFactory">PseudoHashFactory</a></code>).&#160;<a class="footnote-backref" href="#fnref:pseudo-hash" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/laowantong/paroxython/blob/master/paroxython/flatten_ast.py#L0-L606" class="git-link">Browse GitHub</a>
</summary>
<pre><code class="python">import sys
from typing import Any, Callable, Match

import regex  # type: ignore


def select_ast_post_processing():
    if sys.version_info &gt;= (3, 9):

        def post_process(flat_ast):
            flat_ast = suppress_kinds(flat_ast)
            flat_ast = suppress_posonlyargs(flat_ast)
            flat_ast = backport_all_constants(flat_ast)
            flat_ast = simplify_negative_literals(flat_ast)
            flat_ast = unquote(flat_ast)
            return flat_ast

    elif sys.version_info &gt;= (3, 8):

        def post_process(flat_ast):
            flat_ast = suppress_kinds(flat_ast)
            flat_ast = suppress_posonlyargs(flat_ast)
            flat_ast = backport_all_constants(flat_ast)
            flat_ast = simplify_negative_literals(flat_ast)
            flat_ast = simplify_indexes(flat_ast)
            flat_ast = unquote(flat_ast)
            return flat_ast

    else:

        def post_process(flat_ast):
            flat_ast = suppress_kinds(flat_ast)
            flat_ast = simplify_negative_literals(flat_ast)
            flat_ast = simplify_indexes(flat_ast)
            flat_ast = unquote(flat_ast)
            flat_ast = correct_all_decorated_callable_starts(flat_ast)
            return flat_ast

    return post_process


# fmt: off
if sys.version_info &gt;= (3, 8):
    import ast
else:
    from typed_ast import ast3 as ast # type: ignore
post_process = select_ast_post_processing()
# fmt: on


def flatten_ast(tree) -&gt; str:
    pseudo_hash.reset()
    flat_ast = flatten_node(tree)
    flat_ast = post_process(flat_ast)
    return flat_ast


def flatten_node(
    node: Any,
    prefix: str = &#34;&#34;,
    path: str = &#34;&#34;,
    remove_context: Callable = regex.compile(r&#34;, ctx=.+?\(\)&#34;).sub,
) -&gt; str:
    if isinstance(node, ast.AST):
        acc = [f&#34;{prefix}/_type={type(node).__name__}\n&#34;]
        if isinstance(node, ast.expr):
            node_repr = remove_context(&#34;&#34;, ast.dump(node))
            acc.append(f&#34;{prefix}/_hash={pseudo_hash(node_repr)}\n&#34;)
        if &#34;lineno&#34; in node._attributes:
            acc.append(f&#34;{prefix}/_pos={node.lineno}:{path[2:]}\n&#34;)
        fields = ast.iter_fields(node)
        if isinstance(node, (ast.FunctionDef, ast.ClassDef)):
            # make `body` the last item of a `def` clause
            fields = iter(sorted(fields, key=lambda c: c[0] == &#34;body&#34;))
        for (i, (name, x)) in enumerate(fields):
            if name == &#34;orelse&#34; and isinstance(node, (ast.For, ast.While, ast.AsyncFor)):
                name = &#34;loopelse&#34;  # make the `orelse` clause specific to conditionals
            elif name == &#34;targets&#34; and isinstance(node, ast.Assign):
                name = &#34;assigntargets&#34;  # `targets` is also used for `Delete`, etc.
            elif name == &#34;target&#34; and isinstance(node, ast.AugAssign):
                name = &#34;assigntarget&#34;  # `target` is also used for comprehension, etc.
            elif name == &#34;value&#34; and isinstance(node, (ast.Assign, ast.AugAssign)):
                name = &#34;assignvalue&#34;  # `value` is also used for comprehension, etc.
            acc.append(flatten_node(x, f&#34;{prefix}/{name}&#34;, f&#34;{path}{i}-&#34;))
        return &#34;&#34;.join(acc)
    elif isinstance(node, list):
        acc = [f&#34;{prefix}/_length={len(node)}\n&#34;]
        for (i, x) in enumerate(node, 1):  # number the children from 1
            acc.append(flatten_node(x, f&#34;{prefix}/{i}&#34;, f&#34;{path}{i}-&#34;))
        return &#34;&#34;.join(acc)
    else:
        # If the node is a terminal value, dump it
        return f&#34;&#34;&#34;{prefix}={repr(node)}\n&#34;&#34;&#34;


def simplify_negative_literals(
    flat_ast: str,
    sub: Callable = regex.compile(
    ).sub,
) -&gt; str:
    return sub(r&#34;\1/_type=Num\2\1/n=-\3&#34;, flat_ast)


def simplify_indexes(
    flat_ast: str,
    subn_index: Callable = regex.compile(r&#34;(?m)^(.*?)/_type=Index\n&#34;).subn,
    sub_slice_value_pos: Callable = regex.compile(r&#34;(?m)^([^=]*/slice/value/_pos=.+)\d+-&#34;).sub,
    sub_slice_value: Callable = regex.compile(r&#34;(?m)^([^=]*/slice)/value&#34;).sub,
) -&gt; str:
    (flat_ast, n) = subn_index(&#34;&#34;, flat_ast)
    if n == 0:
        return flat_ast
    flat_ast = sub_slice_value_pos(r&#34;\1&#34;, flat_ast)
    return sub_slice_value(r&#34;\1&#34;, flat_ast)


def backport_all_constants(
    flat_ast: str,
    sub: Callable = regex.compile(
    ).sub,
) -&gt; str:
    return sub(replace_one_constant, flat_ast)


def replace_one_constant(m: Match) -&gt; str:
    if m[3].startswith((&#34;&#39;&#34;, &#39;&#34;&#39;)):
        return f&#34;{m[1]}/_type=Str{m[2]}\n{m[1]}/s={m[3]}&#34;
    elif m[3] in (&#34;True&#34;, &#34;False&#34;, &#34;None&#34;):
        return f&#34;{m[1]}/_type=NameConstant{m[2]}\n{m[1]}/value={m[3]}&#34;
    if m[3].startswith(&#34;b&#39;&#34;):
        return f&#34;{m[1]}/_type=Bytes{m[2]}\n{m[1]}/s={m[3]}&#34;
    if m[3] == &#34;Ellipsis&#34;:
        return f&#34;{m[1]}/_type=Ellipsis{m[2]}&#34;
    else:
        return f&#34;{m[1]}/_type=Num{m[2]}\n{m[1]}/n={m[3]}&#34;


def correct_all_decorated_callable_starts(
    flat_ast: str,
    sub: Callable = regex.compile(
    ).sub,
) -&gt; str:
    return sub(replace_one_decorated_callable_start, flat_ast)


def replace_one_decorated_callable_start(m: Match) -&gt; str:
    start = int(m[5]) + int(m[6])  # number of decorators + line number of the first decorator
    return f&#34;{m[1]}/_type={m[2]}{m[3]}{start}:{m[4]}&#34;


def unquote(
    flat_ast: str,
    sub: Callable = regex.compile(r&#34;&#34;&#34;=[&#34;&#39;](.*)[&#39;&#34;]\n&#34;&#34;&#34;).sub,
) -&gt; str:
    return sub(r&#34;=\1\n&#34;, flat_ast)


def suppress_kinds(
    flat_ast: str,
    sub: Callable = regex.compile(r&#34;(?m)^.+/kind=.*\n&#34;).sub,
) -&gt; str:
    return sub(&#34;&#34;, flat_ast)


def suppress_posonlyargs(
    flat_ast: str,
    sub: Callable = regex.compile(r&#34;(?m)^.+/args/posonlyargs/_length=\d+\n&#34;).sub,
) -&gt; str:
    return sub(&#34;&#34;, flat_ast)


__pdoc__ = {&#34;PseudoHashFactory.__call__&#34;: True}


class PseudoHashFactory:
    def __init__(self):
        self.reset()

    def reset(self):
        self.i = 0
        self.cache = {}

    def __call__(self, x):
        if x not in self.cache:
            self.i += 1
            self.cache[x] = f&#34;0x{self.i:04x}&#34;
            # 4.294.967.296 distinct expressions per program ought to be enough for anybody.
        return self.cache[x]


pseudo_hash = PseudoHashFactory()

if __name__ == &#34;__main__&#34;:
    Path = __import__(&#34;pathlib&#34;).Path
    source = Path(&#34;sandbox/source.py&#34;).read_text()
    print(flatten_ast(ast.parse(source)))</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="paroxython.flatten_ast.select_ast_post_processing"><code class="name flex">
<span>def <span class="ident">select_ast_post_processing</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Customize the post-treatment of the <abbr title="Abstract Syntax Tree">AST</abbr> depending on the parser used to create it.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/laowantong/paroxython/blob/master/paroxython/flatten_ast.py#L343-L377" class="git-link">Browse GitHub</a>
</summary>
<pre><code class="python">def select_ast_post_processing():
    if sys.version_info &gt;= (3, 9):

        def post_process(flat_ast):
            flat_ast = suppress_kinds(flat_ast)
            flat_ast = suppress_posonlyargs(flat_ast)
            flat_ast = backport_all_constants(flat_ast)
            flat_ast = simplify_negative_literals(flat_ast)
            flat_ast = unquote(flat_ast)
            return flat_ast

    elif sys.version_info &gt;= (3, 8):

        def post_process(flat_ast):
            flat_ast = suppress_kinds(flat_ast)
            flat_ast = suppress_posonlyargs(flat_ast)
            flat_ast = backport_all_constants(flat_ast)
            flat_ast = simplify_negative_literals(flat_ast)
            flat_ast = simplify_indexes(flat_ast)
            flat_ast = unquote(flat_ast)
            return flat_ast

    else:

        def post_process(flat_ast):
            flat_ast = suppress_kinds(flat_ast)
            flat_ast = simplify_negative_literals(flat_ast)
            flat_ast = simplify_indexes(flat_ast)
            flat_ast = unquote(flat_ast)
            flat_ast = correct_all_decorated_callable_starts(flat_ast)
            return flat_ast

    return post_process</code></pre>
</details>
</dd>
<dt id="paroxython.flatten_ast.post_process"><code class="name flex">
<span>def <span class="ident">post_process</span></span>(<span>flat_ast)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/laowantong/paroxython/blob/master/paroxython/flatten_ast.py#L358-L365" class="git-link">Browse GitHub</a>
</summary>
<pre><code class="python">def post_process(flat_ast):
    flat_ast = suppress_kinds(flat_ast)
    flat_ast = suppress_posonlyargs(flat_ast)
    flat_ast = backport_all_constants(flat_ast)
    flat_ast = simplify_negative_literals(flat_ast)
    flat_ast = simplify_indexes(flat_ast)
    flat_ast = unquote(flat_ast)
    return flat_ast</code></pre>
</details>
</dd>
<dt id="paroxython.flatten_ast.flatten_ast"><code class="name flex">
<span>def <span class="ident">flatten_ast</span></span>(<span>tree) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Return a non-recursive, multiline dump of the <abbr title="Abstract Syntax Tree">AST</abbr> (with some tweaks).</p>
<p>A simple wrapper around the recursive function <code><a title="paroxython.flatten_ast.flatten_node" href="#paroxython.flatten_ast.flatten_node">flatten_node()</a></code>, with post-processing treatments
depending on the <abbr title="Abstract Syntax Tree">AST</abbr> library (either the standard <code>ast</code> module or the third-party <code>typed_ast</code>).</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/laowantong/paroxython/blob/master/paroxython/flatten_ast.py#L389-L398" class="git-link">Browse GitHub</a>
</summary>
<pre><code class="python">def flatten_ast(tree) -&gt; str:
    pseudo_hash.reset()
    flat_ast = flatten_node(tree)
    flat_ast = post_process(flat_ast)
    return flat_ast</code></pre>
</details>
</dd>
<dt id="paroxython.flatten_ast.flatten_node"><code class="name flex">
<span>def <span class="ident">flatten_node</span></span>(<span>node: Any, <br>prefix: str = '', <br>path: str = '', <br>remove_context: Callable = &lt;built-in method sub of regex&gt;<br>) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Traverse recursively (in pre-order) the given <abbr title="Abstract Syntax Tree">AST</abbr> node and flatten its subtree.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>node</code></strong> :&ensp;<code>Any</code></dt>
<dd>The node to traverse. Initially, the whole <abbr title="Abstract Syntax Tree">AST</abbr>.</dd>
<dt><strong><code>prefix</code></strong> :&ensp;<code>str</code>, optional</dt>
<dd>The prefix of the current line to dump. Defaults to <code>""</code>.</dd>
<dt><strong><code>path</code></strong> :&ensp;<code>str</code>, optional</dt>
<dd>The path of the current node. Defaults to <code>""</code>.</dd>
<dt><strong><code>remove_context</code></strong> :&ensp;<code>Callable</code>, optional</dt>
<dd>A function removing the node context encoded in the
result of <code>ast3.dump()</code>.
<a href="developer_manual/index.html#default-argument-trick">Not to be explicitly provided.</a>
Defaults to <code>regex.compile(r", ctx=.+?\(\)").sub</code>.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>A flat representation of the given node.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/laowantong/paroxython/blob/master/paroxython/flatten_ast.py#L401-L450" class="git-link">Browse GitHub</a>
</summary>
<pre><code class="python">def flatten_node(
    node: Any,
    prefix: str = &#34;&#34;,
    path: str = &#34;&#34;,
    remove_context: Callable = regex.compile(r&#34;, ctx=.+?\(\)&#34;).sub,
) -&gt; str:
    if isinstance(node, ast.AST):
        acc = [f&#34;{prefix}/_type={type(node).__name__}\n&#34;]
        if isinstance(node, ast.expr):
            node_repr = remove_context(&#34;&#34;, ast.dump(node))
            acc.append(f&#34;{prefix}/_hash={pseudo_hash(node_repr)}\n&#34;)
        if &#34;lineno&#34; in node._attributes:
            acc.append(f&#34;{prefix}/_pos={node.lineno}:{path[2:]}\n&#34;)
        fields = ast.iter_fields(node)
        if isinstance(node, (ast.FunctionDef, ast.ClassDef)):
            # make `body` the last item of a `def` clause
            fields = iter(sorted(fields, key=lambda c: c[0] == &#34;body&#34;))
        for (i, (name, x)) in enumerate(fields):
            if name == &#34;orelse&#34; and isinstance(node, (ast.For, ast.While, ast.AsyncFor)):
                name = &#34;loopelse&#34;  # make the `orelse` clause specific to conditionals
            elif name == &#34;targets&#34; and isinstance(node, ast.Assign):
                name = &#34;assigntargets&#34;  # `targets` is also used for `Delete`, etc.
            elif name == &#34;target&#34; and isinstance(node, ast.AugAssign):
                name = &#34;assigntarget&#34;  # `target` is also used for comprehension, etc.
            elif name == &#34;value&#34; and isinstance(node, (ast.Assign, ast.AugAssign)):
                name = &#34;assignvalue&#34;  # `value` is also used for comprehension, etc.
            acc.append(flatten_node(x, f&#34;{prefix}/{name}&#34;, f&#34;{path}{i}-&#34;))
        return &#34;&#34;.join(acc)
    elif isinstance(node, list):
        acc = [f&#34;{prefix}/_length={len(node)}\n&#34;]
        for (i, x) in enumerate(node, 1):  # number the children from 1
            acc.append(flatten_node(x, f&#34;{prefix}/{i}&#34;, f&#34;{path}{i}-&#34;))
        return &#34;&#34;.join(acc)
    else:
        # If the node is a terminal value, dump it
        return f&#34;&#34;&#34;{prefix}={repr(node)}\n&#34;&#34;&#34;</code></pre>
</details>
</dd>
<dt id="paroxython.flatten_ast.simplify_negative_literals"><code class="name flex">
<span>def <span class="ident">simplify_negative_literals</span></span>(<span>flat_ast: str, <br>sub: Callable = &lt;built-in method sub of regex&gt;<br>) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p><a href="#negative-literal-simplification">Simplify the negative literals</a> of a given flat <abbr title="Abstract Syntax Tree">AST</abbr>.</p>
<p>Argument <code>sub</code> <a href="developer_manual/index.html#default-argument-trick">not to be explicitly provided.</a></p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/laowantong/paroxython/blob/master/paroxython/flatten_ast.py#L453-L467" class="git-link">Browse GitHub</a>
</summary>
<pre><code class="python">def simplify_negative_literals(
    flat_ast: str,
    sub: Callable = regex.compile(
    ).sub,
) -&gt; str:
    return sub(r&#34;\1/_type=Num\2\1/n=-\3&#34;, flat_ast)</code></pre>
</details>
</dd>
<dt id="paroxython.flatten_ast.simplify_indexes"><code class="name flex">
<span>def <span class="ident">simplify_indexes</span></span>(<span>flat_ast: str, <br>subn_index: Callable = &lt;built-in method subn of regex&gt;, <br>sub_slice_value_pos: Callable = &lt;built-in method sub of regex&gt;, <br>sub_slice_value: Callable = &lt;built-in method sub of regex&gt;<br>) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p><a href="#index-simplification">Simplify the indexes</a> of a given flat <abbr title="Abstract Syntax Tree">AST</abbr>.</p>
<p>Argument <code>sub</code> <a href="developer_manual/index.html#default-argument-trick">not to be explicitly provided.</a></p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/laowantong/paroxython/blob/master/paroxython/flatten_ast.py#L470-L484" class="git-link">Browse GitHub</a>
</summary>
<pre><code class="python">def simplify_indexes(
    flat_ast: str,
    subn_index: Callable = regex.compile(r&#34;(?m)^(.*?)/_type=Index\n&#34;).subn,
    sub_slice_value_pos: Callable = regex.compile(r&#34;(?m)^([^=]*/slice/value/_pos=.+)\d+-&#34;).sub,
    sub_slice_value: Callable = regex.compile(r&#34;(?m)^([^=]*/slice)/value&#34;).sub,
) -&gt; str:
    (flat_ast, n) = subn_index(&#34;&#34;, flat_ast)
    if n == 0:
        return flat_ast
    flat_ast = sub_slice_value_pos(r&#34;\1&#34;, flat_ast)
    return sub_slice_value(r&#34;\1&#34;, flat_ast)</code></pre>
</details>
</dd>
<dt id="paroxython.flatten_ast.backport_all_constants"><code class="name flex">
<span>def <span class="ident">backport_all_constants</span></span>(<span>flat_ast: str, <br>sub: Callable = &lt;built-in method sub of regex&gt;<br>) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Restore the more detailed representation of constants used before Python 3.8.</p>
<p>Argument <code>sub</code> <a href="developer_manual/index.html#default-argument-trick">not to be explicitly provided.</a></p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/laowantong/paroxython/blob/master/paroxython/flatten_ast.py#L487-L501" class="git-link">Browse GitHub</a>
</summary>
<pre><code class="python">def backport_all_constants(
    flat_ast: str,
    sub: Callable = regex.compile(
    ).sub,
) -&gt; str:
    return sub(replace_one_constant, flat_ast)</code></pre>
</details>
</dd>
<dt id="paroxython.flatten_ast.replace_one_constant"><code class="name flex">
<span>def <span class="ident">replace_one_constant</span></span>(<span>m: Match) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Define the replacement function used in <code><a title="paroxython.flatten_ast.backport_all_constants" href="#paroxython.flatten_ast.backport_all_constants">backport_all_constants()</a></code>.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/laowantong/paroxython/blob/master/paroxython/flatten_ast.py#L504-L515" class="git-link">Browse GitHub</a>
</summary>
<pre><code class="python">def replace_one_constant(m: Match) -&gt; str:
    if m[3].startswith((&#34;&#39;&#34;, &#39;&#34;&#39;)):
        return f&#34;{m[1]}/_type=Str{m[2]}\n{m[1]}/s={m[3]}&#34;
    elif m[3] in (&#34;True&#34;, &#34;False&#34;, &#34;None&#34;):
        return f&#34;{m[1]}/_type=NameConstant{m[2]}\n{m[1]}/value={m[3]}&#34;
    if m[3].startswith(&#34;b&#39;&#34;):
        return f&#34;{m[1]}/_type=Bytes{m[2]}\n{m[1]}/s={m[3]}&#34;
    if m[3] == &#34;Ellipsis&#34;:
        return f&#34;{m[1]}/_type=Ellipsis{m[2]}&#34;
    else:
        return f&#34;{m[1]}/_type=Num{m[2]}\n{m[1]}/n={m[3]}&#34;</code></pre>
</details>
</dd>
<dt id="paroxython.flatten_ast.correct_all_decorated_callable_starts"><code class="name flex">
<span>def <span class="ident">correct_all_decorated_callable_starts</span></span>(<span>flat_ast: str, <br>sub: Callable = &lt;built-in method sub of regex&gt;<br>) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Make the span of a decorated callable starting from <code>def</code>, not from the first decorator.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The bug is present in the third-party module <code>typed_ast</code>, but fixed in Python 3.8's standard
library <code>ast</code>.</p>
</div>
<p>Argument <code>sub</code> <a href="developer_manual/index.html#default-argument-trick">not to be explicitly provided.</a></p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/laowantong/paroxython/blob/master/paroxython/flatten_ast.py#L518-L537" class="git-link">Browse GitHub</a>
</summary>
<pre><code class="python">def correct_all_decorated_callable_starts(
    flat_ast: str,
    sub: Callable = regex.compile(
    ).sub,
) -&gt; str:
    return sub(replace_one_decorated_callable_start, flat_ast)</code></pre>
</details>
</dd>
<dt id="paroxython.flatten_ast.replace_one_decorated_callable_start"><code class="name flex">
<span>def <span class="ident">replace_one_decorated_callable_start</span></span>(<span>m: Match) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Define the replacement function used in <code><a title="paroxython.flatten_ast.correct_all_decorated_callable_starts" href="#paroxython.flatten_ast.correct_all_decorated_callable_starts">correct_all_decorated_callable_starts()</a></code>.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/laowantong/paroxython/blob/master/paroxython/flatten_ast.py#L540-L543" class="git-link">Browse GitHub</a>
</summary>
<pre><code class="python">def replace_one_decorated_callable_start(m: Match) -&gt; str:
    start = int(m[5]) + int(m[6])  # number of decorators + line number of the first decorator
    return f&#34;{m[1]}/_type={m[2]}{m[3]}{start}:{m[4]}&#34;</code></pre>
</details>
</dd>
<dt id="paroxython.flatten_ast.unquote"><code class="name flex">
<span>def <span class="ident">unquote</span></span>(<span>flat_ast: str, <br>sub: Callable = &lt;built-in method sub of regex&gt;<br>) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Suppress the quote delimiters after “=“ to simplify the regular expressions of <a href="https://github.com/laowantong/paroxython/blob/master/paroxython/resources/spec.md"><code>spec.md</code></a>.</p>
<p>Argument <code>sub</code> <a href="developer_manual/index.html#default-argument-trick">not to be explicitly provided.</a></p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/laowantong/paroxython/blob/master/paroxython/flatten_ast.py#L546-L554" class="git-link">Browse GitHub</a>
</summary>
<pre><code class="python">def unquote(
    flat_ast: str,
    sub: Callable = regex.compile(r&#34;&#34;&#34;=[&#34;&#39;](.*)[&#39;&#34;]\n&#34;&#34;&#34;).sub,
) -&gt; str:
    return sub(r&#34;=\1\n&#34;, flat_ast)</code></pre>
</details>
</dd>
<dt id="paroxython.flatten_ast.suppress_kinds"><code class="name flex">
<span>def <span class="ident">suppress_kinds</span></span>(<span>flat_ast: str, <br>sub: Callable = &lt;built-in method sub of regex&gt;<br>) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Suppress all leaves containing <code>/kind=</code>. They are useless in the following.</p>
<p>Argument <code>sub</code> <a href="developer_manual/index.html#default-argument-trick">not to be explicitly provided.</a></p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/laowantong/paroxython/blob/master/paroxython/flatten_ast.py#L557-L565" class="git-link">Browse GitHub</a>
</summary>
<pre><code class="python">def suppress_kinds(
    flat_ast: str,
    sub: Callable = regex.compile(r&#34;(?m)^.+/kind=.*\n&#34;).sub,
) -&gt; str:
    return sub(&#34;&#34;, flat_ast)</code></pre>
</details>
</dd>
<dt id="paroxython.flatten_ast.suppress_posonlyargs"><code class="name flex">
<span>def <span class="ident">suppress_posonlyargs</span></span>(<span>flat_ast: str, <br>sub: Callable = &lt;built-in method sub of regex&gt;<br>) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Starting from Python 3.8, suppress positional-only parameters in function definitions.</p>
<p>Argument <code>sub</code> <a href="developer_manual/index.html#default-argument-trick">not to be explicitly provided.</a></p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/laowantong/paroxython/blob/master/paroxython/flatten_ast.py#L568-L576" class="git-link">Browse GitHub</a>
</summary>
<pre><code class="python">def suppress_posonlyargs(
    flat_ast: str,
    sub: Callable = regex.compile(r&#34;(?m)^.+/args/posonlyargs/_length=\d+\n&#34;).sub,
) -&gt; str:
    return sub(&#34;&#34;, flat_ast)</code></pre>
</details>
</dd>
</dl>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="paroxython.flatten_ast.PseudoHashFactory"><code class="flex name class">
<span>class <span class="ident">PseudoHashFactory</span></span>
</code></dt>
<dd>
<div class="desc"><p>A factory that creates a deterministic replacement for the <code>hash()</code> builtin function.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/laowantong/paroxython/blob/master/paroxython/flatten_ast.py#L582-L599" class="git-link">Browse GitHub</a>
</summary>
<pre><code class="python">class PseudoHashFactory:
    def __init__(self):
        self.reset()

    def reset(self):
        self.i = 0
        self.cache = {}

    def __call__(self, x):
        if x not in self.cache:
            self.i += 1
            self.cache[x] = f&#34;0x{self.i:04x}&#34;
            # 4.294.967.296 distinct expressions per program ought to be enough for anybody.
        return self.cache[x]</code></pre>
</details>
<h3>Methods</h3>
<dl>
<dt id="paroxython.flatten_ast.PseudoHashFactory.reset"><code class="name flex">
<span>def <span class="ident">reset</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Restart the global counter and empties the cache.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/laowantong/paroxython/blob/master/paroxython/flatten_ast.py#L588-L591" class="git-link">Browse GitHub</a>
</summary>
<pre><code class="python">def reset(self):
    self.i = 0
    self.cache = {}</code></pre>
</details>
</dd>
<dt id="paroxython.flatten_ast.PseudoHashFactory.__call__"><code class="name flex">
<span>def <span class="ident">__call__</span></span>(<span>self, x)</span>
</code></dt>
<dd>
<div class="desc"><p>Return a 4-digits hexadecimal identifier for the given immutable value.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/laowantong/paroxython/blob/master/paroxython/flatten_ast.py#L593-L599" class="git-link">Browse GitHub</a>
</summary>
<pre><code class="python">def __call__(self, x):
    if x not in self.cache:
        self.i += 1
        self.cache[x] = f&#34;0x{self.i:04x}&#34;
        # 4.294.967.296 distinct expressions per program ought to be enough for anybody.
    return self.cache[x]</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<header>
<a class="homelink" rel="home" title="Paroxython Home" href="index.html">
<img src="https://laowantong.github.io/paroxython/resources/logo.png" alt="Paroxython logo">
</a>
</header>
<h1>Index</h1>
<div class="toc">
<ul>
<li><a href="#motivation-and-purpose">Motivation and purpose</a></li>
<li><a href="#implementation-details">Implementation details</a><ul>
<li><a href="#libraries-used">Libraries used</a></li>
<li><a href="#on-the-fly-modification-of-the-ast">On the fly: modification of the AST</a><ul>
<li><a href="#field-reordering">Field reordering</a></li>
<li><a href="#children-numbering">Children numbering</a></li>
<li><a href="#field-disambiguation">Field disambiguation</a></li>
<li><a href="#added-fields">Added fields</a></li>
<li><a href="#expression-decontextualization-and-hashing">Expression decontextualization and hashing</a></li>
</ul>
</li>
<li><a href="#after-the-fact-modification-of-the-flattened-ast">After the fact: modification of the flattened AST</a><ul>
<li><a href="#negative-literal-simplification">Negative literal simplification</a></li>
<li><a href="#index-simplification">Index simplification</a></li>
<li><a href="#suppressing-useless-lines">Suppressing useless lines</a></li>
<li><a href="#reverting-the-representation-of-constants-to-the-good-ol-days">Reverting the representation of constants to the good ol' days</a></li>
<li><a href="#unquoting-strings">Unquoting strings</a></li>
<li><a href="#correcting-the-span-of-decorated-callable">Correcting the span of decorated callable</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="paroxython" href="index.html">paroxython</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="paroxython.flatten_ast.select_ast_post_processing" href="#paroxython.flatten_ast.select_ast_post_processing">select_ast_post_processing</a></code></li>
<li><code><a title="paroxython.flatten_ast.post_process" href="#paroxython.flatten_ast.post_process">post_process</a></code></li>
<li><code><a title="paroxython.flatten_ast.flatten_ast" href="#paroxython.flatten_ast.flatten_ast">flatten_ast</a></code></li>
<li><code><a title="paroxython.flatten_ast.flatten_node" href="#paroxython.flatten_ast.flatten_node">flatten_node</a></code></li>
<li><code><a title="paroxython.flatten_ast.simplify_negative_literals" href="#paroxython.flatten_ast.simplify_negative_literals">simplify_negative_literals</a></code></li>
<li><code><a title="paroxython.flatten_ast.simplify_indexes" href="#paroxython.flatten_ast.simplify_indexes">simplify_indexes</a></code></li>
<li><code><a title="paroxython.flatten_ast.backport_all_constants" href="#paroxython.flatten_ast.backport_all_constants">backport_all_constants</a></code></li>
<li><code><a title="paroxython.flatten_ast.replace_one_constant" href="#paroxython.flatten_ast.replace_one_constant">replace_one_constant</a></code></li>
<li><code><a title="paroxython.flatten_ast.correct_all_decorated_callable_starts" href="#paroxython.flatten_ast.correct_all_decorated_callable_starts">correct_all_decorated_callable_starts</a></code></li>
<li><code><a title="paroxython.flatten_ast.replace_one_decorated_callable_start" href="#paroxython.flatten_ast.replace_one_decorated_callable_start">replace_one_decorated_callable_start</a></code></li>
<li><code><a title="paroxython.flatten_ast.unquote" href="#paroxython.flatten_ast.unquote">unquote</a></code></li>
<li><code><a title="paroxython.flatten_ast.suppress_kinds" href="#paroxython.flatten_ast.suppress_kinds">suppress_kinds</a></code></li>
<li><code><a title="paroxython.flatten_ast.suppress_posonlyargs" href="#paroxython.flatten_ast.suppress_posonlyargs">suppress_posonlyargs</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="paroxython.flatten_ast.PseudoHashFactory" href="#paroxython.flatten_ast.PseudoHashFactory">PseudoHashFactory</a></code></h4>
<ul class="">
<li><code><a title="paroxython.flatten_ast.PseudoHashFactory.reset" href="#paroxython.flatten_ast.PseudoHashFactory.reset">reset</a></code></li>
<li><code><a title="paroxython.flatten_ast.PseudoHashFactory.__call__" href="#paroxython.flatten_ast.PseudoHashFactory.__call__">__call__</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.9.1</a>.</p>
</footer>
</body>
</html>